#!/bin/bash -e

cd "$(dirname "$0")"

. ./config.sh

build()
{
    pushd "$1"
    ln -sf ../patch/* .
cat >system-config.cmake <<EOF
set(CMAKE_MODULE_PATH \${CMAKE_SOURCE_DIR}/../common)
set(ENABLE_TESTS ${ENABLE_TESTS:-no})
foreach(proj ${libs[*]})
    include_directories(\${CMAKE_SOURCE_DIR}/../\${proj}/include)
    link_directories(\${CMAKE_SOURCE_DIR}/../\${proj}/build)
endforeach()
EOF
    if [[ -d java ]]
    then
        pushd java
        mvn package -DskipTests
        popd
        ./jni_gen.sh
        ./jni_validate.sh
    fi
    mkdir -p build
    cd build
    cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_CXX_COMPILER=/usr/bin/g++-4.7 -DCMAKE_C_COMPILER=/usr/bin/gcc-4.7 ..
    make
    popd
}

for i in "${libs[@]}"
do
    build "$i"
done
